---
os: linux
arch: arm64-graviton2
dist: bionic
language: python
python:
  - 3.8
sudo: required
services:
  - docker

jobs:
  include:
    - stage: build-test-push
      install:
        - bash scripts/docker_login.sh
        - pip install --upgrade pip
        - make venv
      script:
        - set -e
        - make build-all
        - make test
      after_success:
        - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
        - bash scripts/after_success.sh

stages:
  - name: build-test-push
    if: branch = main
