---
os: linux
arch: arm64-graviton2
dist: bionic
language: python
python:
  - 3.8
sudo: required
services:
  - docker

jobs:
  include:
    - stage: full-test
      install:
        - pip install --upgrade pip
        - make venv
      script:
        - set -e
        - travis_wait 60 make build-all
        - make test
    - stage: push-images
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push illumidesk/base-notebook:latest
        - docker push illumidesk/illumidesk-notebook:latest
        - docker push illumidesk/grader-notebook:latest
        - docker tag illumidesk/illumidesk-notebook:latest illumidesk/illumidesk-notebook:${TRAVIS_COMMIT}
        - docker tag illumidesk/grader-notebook:latest illumidesk/grader-notebook:${TRAVIS_COMMIT}
        - docker tag illumidesk/base-notebook:latest illumidesk/base-notebook:${TRAVIS_COMMIT}
        - docker push illumidesk/base-notebook:${TRAVIS_COMMIT}
        - docker push illumidesk/illumidesk-notebook:${TRAVIS_COMMIT}
        - docker push illumidesk/grader-notebook:${TRAVIS_COMMIT}

stages:
  - name: full-test
    if: branch = main
  - name: push-images
    if: branch = main
